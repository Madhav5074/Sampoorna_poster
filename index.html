<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sampoorna 2.0 Poster Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container {
            max-width: 550px;
            margin: auto;
        }
        
        /* This is the new poster area. No more canvas! */
        #posterWrapper {
            /* This is the key: we use the original image's width.
              The background image will fill this container.
            */
            position: relative;
            width: 100%;
            max-width: 562px; /* Original image width */
            margin: auto;
            border: 2px solid #e2e8f0;
            border-radius: 1.5rem;
            overflow: hidden; /* This clips the photo circle */
        }
        
        #posterBg {
            /* The background image itself */
            width: 100%;
            height: auto;
            display: block; /* Removes any bottom spacing */
        }

        /* This container holds all the elements layered on top */
        .overlay-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* This is the employee's photo */
        #employeePhotoPreview {
            position: absolute;
            /* These % values are calculated from the original image.
              (top: 647px / 1000px height = 64.7%)
              (left: 117px / 562px width = 20.8%)
            */
            top: 64.7%;
            left: 20.8%;
            width: 23%;   /* (130px / 562px) */
            height: 13%;  /* (130px / 1000px) */
            border-radius: 50%;
            object-fit: cover; /* This makes the image fill the circle nicely */
            background-color: #00aef0; /* Fallback color */
        }

        /* This is the class for all text elements */
        .poster-text {
            position: absolute;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            /* Using 'vw' (viewport width) makes the font scale with the poster size.
              We use a media query to set a fixed size when the viewport is larger.
            */
            font-size: 1.55vw; 
            color: #0a304f; /* Dark blue from poster */
            white-space: nowrap; /* Prevents text from wrapping */
        }
        
        /* This sets a fixed font size on larger screens */
        @media (min-width: 562px) {
            .poster-text {
                /* 1.55vw at 562px = 8.7px. This keeps it consistent. */
                font-size: 8.7px; 
            }
        }
        
        /* Here we position each text element individually.
          The % values are calculated from the original image.
        */
        #p-name {
            top: 65.1%; /* (651px / 1000px) */
            left: 58.7%;  /* (330px / 562px) - after the "Name: " label */
        }
        #p-branch {
            top: 67.9%;
            left: 58.7%;
        }
        #p-region {
            top: 70.7%;
            left: 58.7%;
        }
        #p-premium {
            top: 73.5%;
            left: 73.8%; /* Further right, after "Premium Amount: " */
        }
        #p-nop {
            top: 76.3%;
            left: 55.2%; /* After "NOP: " */
        }
        
        #posterContainer, #loadingIndicator {
            display: none;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #0c4a6e;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-6">

    <div class="container bg-white p-10 rounded-3xl shadow-2xl flex flex-col gap-8">

        <form id="posterForm" class="flex flex-col gap-6">
            <h1 class="text-4xl font-extrabold text-center text-blue-900 mb-2">Sampoorna 2.0 Poster</h1>

            <div>
                <label for="employeePhotoUpload" class="block text-sm font-semibold text-gray-700 mb-2">Upload Employee Photo</label>
                <input type="file" id="employeePhotoUpload" accept="image/*" required class="w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0
                    file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100 cursor-pointer">
            </div>
            
            <div>
                <label for="employeeName" class="block text-sm font-semibold text-gray-700 mb-1">Employee Name</label>
                <input type="text" id="employeeName" placeholder="Enter Employee Name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
                <label for="branch" class="block text-sm font-semibold text-gray-700 mb-1">Branch</label>
                <input type="text" id="branch" placeholder="Enter Branch" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
                <label for="region" class="block text-sm font-semibold text-gray-700 mb-1">Region</label>
                <input type="text" id="region" placeholder="Enter Region" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
                <label for="premium" class="block text-sm font-semibold text-gray-700 mb-1">Premium Amount</label>
                <input type="tel" id="premium" placeholder="Enter Premium Amount" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
                <label for="nop" class="block text-sm font-semibold text-gray-700 mb-1">NOP (Number of Policies)</label>
                <input type="number" id="nop" placeholder="Enter NOP" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <button type="submit" id="generateBtn" class="bg-gradient-to-r from-blue-600 to-blue-800 text-white font-bold py-3 rounded-lg shadow-lg hover:from-blue-700 hover:to-blue-900 transition duration-300 transform hover:scale-105">Generate Poster</button>
        </form>

        <div id="loadingIndicator" class="flex flex-col items-center gap-4">
            <div class="spinner"></div>
            <p class="text-gray-700 font-semibold">Generating...</p>
        </div>

        <div id="posterContainer" class="flex flex-col items-center gap-6">
            
            <div id="posterWrapper">
                <img id="posterBg" src="./sampoorna-bg.PNG" alt="Sampoorna Poster Background">
                
                <div class="overlay-container">
                    <img id="employeePhotoPreview" src="" alt="Employee Photo">
                    
                    <p id="p-name" class="poster-text"></p>
                    <p id="p-branch" class="poster-text"></p>
                    <p id="p-region" class="poster-text"></p>
                    <p id="p-premium" class="poster-text"></p>
                    <p id="p-nop" class="poster-text"></p>
                </div>
            </div>
            
            <button id="downloadBtn" class="bg-gradient-to-r from-green-600 to-green-800 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:from-green-700 hover:to-green-900 transition duration-300 transform hover:scale-105">Download Poster</button>
        </div>
        
    </div>
    
    <div class="version-number">
        Version 3.2 - CSS Overlay
    </div>
    <div class="copyright-text">
        Copyright © MADHAV KALRA
    </div>

    <script>
        const posterForm = document.getElementById('posterForm');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const posterContainer = document.getElementById('posterContainer');
        const downloadBtn = document.getElementById('downloadBtn');
        const premiumInput = document.getElementById('premium');

        // References to the new poster elements
        const employeePhotoPreview = document.getElementById('employeePhotoPreview');
        const pName = document.getElementById('p-name');
        const pBranch = document.getElementById('p-branch');
        const pRegion = document.getElementById('p-region');
        const pPremium = document.getElementById('p-premium');
        const pNop = document.getElementById('p-nop');

        premiumInput.addEventListener('input', function(event) {
            const value = this.value.replace(/[^0-9]/g, '');
            if (value) {
                this.value = `₹${Number(value).toLocaleString('en-IN')}`;
            } else {
                this.value = '';
            }
        });

        posterForm.addEventListener('submit', function(event) {
            event.preventDefault();

            const employeePhotoInput = document.getElementById('employeePhotoUpload');
            const file = employeePhotoInput.files[0];
            
            if (!file) {
                showMessage("Please upload an Employee photo.");
                return;
            }

            posterForm.style.display = 'none';
            loadingIndicator.style.display = 'flex';

            // We don't need to load the template, it's already in the HTML.
            // We just need to load the employee photo.
            const reader = new FileReader();
            reader.onload = function(e) {
                // This function is much simpler now!
                // It just updates the text and image sources.
                drawPoster(e.target.result, {
                    employeeName: document.getElementById('employeeName').value,
                    branch: document.getElementById('branch').value,
                    region: document.getElementById('region').value,
                    premium: document.getElementById('premium').value,
                    nop: document.getElementById('nop').value
                });
                
                // Use a small timeout to make sure images have rendered
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                    posterContainer.style.display = 'flex';
                }, 100); // 100ms delay
            };
            reader.readAsDataURL(file);
        });

        function showMessage(message) {
            let messageBox = document.getElementById('messageBox');
            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = 'messageBox';
                messageBox.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50';
                messageBox.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl text-center flex flex-col items-center gap-4">
                        <p class="text-lg font-semibold text-gray-800">${message}</p>
                        <button onclick="this.parentNode.parentNode.style.display='none'" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">OK</button>
                    </div>
                `;
                document.body.appendChild(messageBox);
            } else {
                messageBox.querySelector('p').textContent = message;
                messageBox.style.display = 'flex';
            }
        }

        // This function is now simple, just updating the HTML.
        function drawPoster(employeeImageSrc, data) {
            employeePhotoPreview.src = employeeImageSrc;
            
            pName.innerText = data.employeeName;
            pBranch.innerText = data.branch;
            pRegion.innerText = data.region;
            pPremium.innerText = data.premium;
            pNop.innerText = data.nop;
        }

        // The new download function using html2canvas
        downloadBtn.addEventListener('click', function() {
            const posterToDownload = document.getElementById('posterWrapper');
            
            // html2canvas options for better quality
            const options = {
                scale: 3, // Increase scale for higher resolution (3x)
                useCORS: true, // For images from other origins
                // Set a white background for any potential transparency
                backgroundColor: '#ffffff' 
            };

            html2canvas(posterToDownload, options).then(canvas => {
                // Convert the canvas (our "screenshot") to a data URL
                const imageDataUrl = canvas.toDataURL('image/png');
                
                // Create a temporary link to download it
                const downloadLink = document.createElement('a');
                downloadLink.download = `sampoorna-poster-${Date.now()}.png`;
                downloadLink.href = imageDataUrl;
                
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            });
        });
    </script>
</body>
</html>
